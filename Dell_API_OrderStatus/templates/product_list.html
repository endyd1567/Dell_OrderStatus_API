<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì£¼ê°„ ì…ê³  ë‚´ì—­ ì¡°íšŒ</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/5.11.3/main.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/5.11.3/main.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
	
</head>
<body>
    <div class="container mt-5">

	<div class="text-right mb-3">
	<button class="btn btn-primary" id="filter-all">ğŸ“¦ ëª¨ë“  ì œí’ˆ ì¡°íšŒ</button>
	<button class="btn btn-success" id="filter-shipped">âœ… ì¶œê³  ì œí’ˆ ì¡°íšŒ</button>
    <button class="btn btn-warning" id="filter-unshipped">ğŸšš ë¯¸ì¶œê³  ì œí’ˆ ì¡°íšŒ</button>
</div>


	<h2 class="mb-4">ğŸ” ì…ê³  ì¥ë¹„ ì°¾ê¸°</h2>
	<form id="search-form" method="GET" action="/search">
    <div class="form-group">
    <label for="search-field">ê²€ìƒ‰ í•„ë“œ ì„ íƒ:</label>
    <select id="search-field" name="field" class="form-control" style="width: 200px;">
        <option value="purchase_order_number" {% if selected_field == 'purchase_order_number' %}selected{% endif %}>êµ¬ë§¤ ì£¼ë¬¸ ë²ˆí˜¸</option>
        <option value="order_number" {% if selected_field == 'order_number' %}selected{% endif %}>Dell ì£¼ë¬¸ ë²ˆí˜¸</option>
        <option value="product_description" {% if selected_field == 'product_description' %}selected{% endif %}>ì œí’ˆ ì„¤ëª…</option>
    </select>
</div>

    <div class="form-group">
    <label for="search-value">ê²€ìƒ‰ ê°’:</label>
    <div class="d-flex">
        <input type="text" id="search-value" name="value" class="form-control" style="width: 200px;" 
               placeholder="ê²€ìƒ‰í•  ê°’ì„ ì…ë ¥í•˜ì„¸ìš”" value="{{ search_value }}">
        <button type="submit" class="btn btn-primary ml-2">ê²€ìƒ‰</button>
    </div>
    <small id="search-warning" class="text-danger" style="display: none;">âš  ê²€ìƒ‰ ê°’ì„ ì…ë ¥í•˜ì„¸ìš”.</small> <!-- âœ… ê²½ê³  ë©”ì‹œì§€ -->
</div>



</form>

    </form>
		<br>
        <h2 class="mb-4">ğŸ“… ì£¼ê°„ ì…ê³  ë‚´ì—­ ì¡°íšŒ</h2>
        
        <div class="form-group">
            <label for="manual-date">ë‚ ì§œ ì…ë ¥:</label>
            <input type="date" id="manual-date" class="form-control d-inline-block" style="width: 150px;">
            <button class="btn btn-primary ml-2" onclick="fetchOrdersByDate()">ì¡°íšŒ</button>
        </div>

        <div id="calendar" class="mt-3"></div>

        <h4 class="mt-4">ğŸ“¦ 
    <span id="selected-week">
        {% if selected_filter == "unshipped" %}
            ë¯¸ì¶œê³  ì œí’ˆ ì¡°íšŒ ê²°ê³¼ 
        {% elif selected_filter == "shipped" %}
            ì¶œê³  ì œí’ˆ ì¡°íšŒ ê²°ê³¼ 
        {% elif selected_filter == "all" %}
            ëª¨ë“  ì œí’ˆ ì¡°íšŒ ê²°ê³¼ 
        {% elif search_value %}
            "{{ search_value }}" ê²€ìƒ‰ ê²°ê³¼
        {% elif start_date and end_date %}
            {{ start_date }} ~ {{ end_date }}
        {% else %}
            ì£¼ê°„ ë²”ìœ„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”
        {% endif %}
    </span>
</h4>

{% set total_pages = total_pages if total_pages is defined else 1 %}
{% set page = page if page is defined else 1 %}

{% if orders %}
    <table class="table table-bordered text-center">
        <thead class="thead-light">
            <tr>
            <th style="width: 120px;">ì…ê³  ë‚ ì§œ</th>
            <th style="width: 150px;">Dell ì£¼ë¬¸ ë²ˆí˜¸</th>
            <th style="width: 170px;">êµ¬ë§¤ ì£¼ë¬¸ ë²ˆí˜¸</th>
            <th style="width: 300px;">ì œí’ˆ ì„¤ëª…</th>
            <th style="width: 60px;">ìˆ˜ëŸ‰</th>
            <th style="width: 100px;">ì¶œê³ ì²˜ë¦¬</th>
			 <th style="width: 200px;">ë¹„ê³ </th>
            </tr>
        </thead>
        <tbody>
            {% for order in orders %}
                {% for product in order.products %}
                    <tr>
                        {% if loop.first %}
                            <td rowspan="{{ order.products|length }}">{{ order.created_at }}</td>
                            <td rowspan="{{ order.products|length }}">{{ order.order_number }}</td>
                            <td rowspan="{{ order.products|length }}">{{ order.purchase_order_number }}</td>
                        {% endif %}
                        <td>{{ product.description }}</td>
                        <td>{{ product.itemQuantity }}</td>
                        <td class="text-center">
                            <input type="checkbox" class="shipped-checkbox" 
                                   data-order-number="{{ order.order_number }}"
                                   {% if order.shipped == 1 %} checked {% endif %}>
                        </td>
						<td>
                    <input type="text" class="form-control memo-input" 
                           data-order-number="{{ order.order_number }}"
                           value="{{ order.memo or '' }}"
                           placeholder="ë©”ëª¨ ì…ë ¥">
						</td>
                    </tr>
                {% endfor %}
            {% endfor %}
        </tbody>
    </table>

    <!-- âœ… í˜ì´ì§• ë²„íŠ¼ ì¶”ê°€ -->
    {% if total_pages > 1 %}
    <div class="text-center mt-4">
        {% if page > 1 %}
            <a href="{{ request.path }}?field={{ selected_field }}&value={{ search_value }}&page={{ page-1 }}" class="btn btn-primary">Â« ì´ì „</a>
        {% endif %}
        
        <span class="mx-3">í˜ì´ì§€ {{ page }} / {{ total_pages }}</span>
        
        {% if page < total_pages %}
            <a href="{{ request.path }}?field={{ selected_field }}&value={{ search_value }}&page={{ page+1 }}" class="btn btn-primary">ë‹¤ìŒ Â»</a>
        {% endif %}
    </div>
    {% endif %}

{% else %}
    <div class="alert alert-warning text-center">
        ì„ íƒí•œ ë²”ìœ„ì— ì €ì¥ëœ ì£¼ë¬¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
    </div>
{% endif %}


        <div class="text-center mt-4">
            <a href="/" class="btn btn-primary">í™ˆìœ¼ë¡œ</a>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');

    var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'timeGridWeek',
        firstDay: 0,  // ì£¼ì˜ ì‹œì‘ì„ ì¼ìš”ì¼ë¡œ ì„¤ì •
        selectable: true,
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek'
        },
        select: function(info) {
            let startDate = moment(info.start).format('YYYY-MM-DD');
            let endDate = moment(info.end).subtract(1, 'days').format('YYYY-MM-DD');

            // "ì„ íƒëœ ì£¼ì°¨" í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            document.getElementById("selected-week").innerText = `${startDate} ~ ${endDate}`;
            
            // ì„œë²„ë¡œ ë‚ ì§œ ë²”ìœ„ ì „ì†¡
            window.location.href = `/order_list?start_date=${startDate}&end_date=${endDate}`;
        },
        events: [
            {% for date in available_dates %}
            {
                title: "ğŸ“¦ ì£¼ë¬¸ ìˆìŒ",
                start: "{{ date }}",
                allDay: true
            },
            {% endfor %}
        ]
    });

    calendar.render();
});

function fetchOrdersByDate() {
    let manualDate = document.getElementById("manual-date").value;
    if (manualDate) {
        let startDate = moment(manualDate).startOf('week').format('YYYY-MM-DD');
        let endDate = moment(manualDate).endOf('week').format('YYYY-MM-DD');
        
        // "ì„ íƒëœ ì£¼ì°¨" í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        document.getElementById("selected-week").innerText = `${startDate} ~ ${endDate}`;

        // ì„œë²„ë¡œ ë‚ ì§œ ë²”ìœ„ ì „ì†¡
        window.location.href = `/order_list?start_date=${startDate}&end_date=${endDate}`;
    } else {
        alert("ë‚ ì§œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
    }
}
$(document).ready(function() {
    // âœ… ë¯¸ì¶œê³  ì œí’ˆ ì¡°íšŒ
    $("#filter-unshipped").on("click", function() {
        window.location.href = "/search_unshipped";
    });

    // âœ… ì¶œê³  ì œí’ˆ ì¡°íšŒ
    $("#filter-shipped").on("click", function() {
        window.location.href = "/search_shipped";
    });

    // âœ… ëª¨ë“  ì œí’ˆ ì¡°íšŒ
    $("#filter-all").on("click", function() {
        window.location.href = "/search_all";
    });

    // âœ… ì¶œê³  ì²´í¬ë°•ìŠ¤ ë³€ê²½ ì‹œ AJAX ìš”ì²­
    $(".shipped-checkbox").on("change", function() {
        let orderNumber = $(this).data("order-number");
        let shipped = $(this).is(":checked");

        $.ajax({
            url: "/update_shipped_status",
            type: "POST",
            data: { order_number: orderNumber, shipped: shipped },
            success: function(response) {
                console.log(response.message);
            },
            error: function(xhr, status, error) {
                console.error("ì¶œê³  ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:", error);
                alert("ì¶œê³  ìƒíƒœ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        });
    });
});

$(document).ready(function() {
    let params = new URLSearchParams(window.location.search);
    let field = params.get("field") || "";
    let value = params.get("value") || "";

    $(".pagination-link").each(function() {
        let url = $(this).attr("href");
        $(this).attr("href", url + "&field=" + field + "&value=" + value);
    });
});

$(document).ready(function() {
    $("#search-form").on("submit", function(event) {
        let searchValue = $("#search-value").val().trim();
        
        if (searchValue === "") {
            $("#search-warning").show();  // âœ… ê²½ê³  ë©”ì‹œì§€ í‘œì‹œ
            event.preventDefault();  // âœ… í¼ ì œì¶œ ë°©ì§€
        }
    });

    // âœ… ì‚¬ìš©ìê°€ ì…ë ¥í•˜ë©´ ê²½ê³  ë©”ì‹œì§€ ìˆ¨ê¹€
    $("#search-value").on("input", function() {
        $("#search-warning").hide();
    });
});

<!-- âœ… JavaScript ì•„ë˜ì— ì¶”ê°€ -->
$(document).on("input", ".memo-input", function() {
    let input = $(this);
    let orderNumber = input.data("order-number");
    let memo = input.val();

    $.ajax({
        url: "/update_memo",
        type: "POST",
        data: {
            order_number: orderNumber,
            memo: memo
        },
        success: function(response) {
            console.log("ë©”ëª¨ ì €ì¥ ì„±ê³µ:", response.message);
        },
        error: function(xhr, status, error) {
            console.error("ë©”ëª¨ ì €ì¥ ì‹¤íŒ¨:", error);
            alert("ë©”ëª¨ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
        }
    });
});
</script>
</body>
</html>