<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì…ê³  ì¥ë¹„ ë“±ë¡</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <style>
        body {
            background-color: #f9fafb;
            font-family: 'Segoe UI', sans-serif;
        }
        .card {
            margin-top: 30px;
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        .form-section-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            font-weight: bold;
        }
        .file-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #fff;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 5px;
        }
        .file-list button {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9rem;
        }
        #progress-container {
            margin-top: 20px;
            padding: 15px;
            background-color: #f1f5f9;
            border-left: 4px solid #0d6efd;
            border-radius: 5px;
            font-size: 0.95rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card p-4">
            <h4 class="text-center mb-4">ğŸ“¦ ë°•ìŠ¤ ë¼ë²¨ ì—…ë¡œë“œ ë° ìˆ˜ë™ ì…ë ¥</h4>

            {% with messages = get_flashed_messages(with_categories=true) %}
              {% if messages %}
                <div id="progress-container" class="mb-3">
                  <h5 class="form-section-title">ì²˜ë¦¬ ê²°ê³¼</h5>
                  {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                      {{ message }}
                      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                  {% endfor %}
                </div>
              {% endif %}
            {% endwith %}

            <form method="post" action="/process_order" enctype="multipart/form-data">
                <div class="mb-3">
                    <label for="file-input" class="form-section-title">ë¼ë²¨ ì‚¬ì§„ ì—…ë¡œë“œ
                        <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#photoFormatModal">
                            ? ì‚¬ì§„ ì–‘ì‹
                        </button>
                    </label>
                    <input type="file" name="files[]" multiple id="file-input" class="form-control" onchange="updateFileList()">
                    <ul id="file-list" class="file-list mt-3"></ul>
                </div>

                <div class="mb-3">
                    <label class="form-section-title">ìˆ˜ë™ ì£¼ë¬¸ ë²ˆí˜¸ ì…ë ¥</label>
                    <div id="order-number-container" class="d-flex flex-column gap-2">
                        <div class="d-flex gap-2">
                            <input type="text" name="manual_order_numbers[]" class="form-control" placeholder="ì£¼ë¬¸ ë²ˆí˜¸ ì…ë ¥">
                            <select name="box[]" class="form-select" style="max-width: 120px;">
                                <option value="" disabled selected>ë°•ìŠ¤</option>
                                {% for i in range(1, 101) %}<option value="{{ i }}">{{ i }}</option>{% endfor %}
                            </select>
                        </div>
                    </div>
                    <button type="button" class="btn btn-outline-secondary mt-2" onclick="addOrderNumberField()">+ ì£¼ë¬¸ ë²ˆí˜¸ ì¶”ê°€</button>
                </div>

                
                <div class="d-grid mt-4 gap-2">
                    <input type="submit" id="submit-button" value="ì œì¶œ" class="btn btn-primary">
                    <div id="loading-spinner" class="d-none text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</p>
                    </div>
                    <!-- This container will be filled by JavaScript -->
                    <div id="error-container" class="text-center mt-3"></div>
				</div>

			<!-- âœ… ê´€ë¦¬ì í˜¸ì¶œ ë²„íŠ¼ ì¶”ê°€ -->
			<div class="text-center mt-4 d-flex justify-content-center gap-2">
				<a href="/" class="btn btn-outline-dark">ğŸ  í™ˆìœ¼ë¡œ</a>
				<button type="button" class="btn btn-outline-danger bg-white" onclick="notifyAdmin()">ğŸ› ï¸ ì—ëŸ¬ ë°œìƒ ì‹œ</button>
			</div>
				
            </form>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal fade" id="imagePreviewModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center">
                    <img id="modalImage" src="" alt="ë¯¸ë¦¬ë³´ê¸°" class="img-fluid">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Photo Format Help Modal -->
    <div class="modal fade" id="photoFormatModal" tabindex="-1" aria-labelledby="photoFormatModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="photoFormatModalLabel">ğŸ“· ì—…ë¡œë“œ ì‚¬ì§„ ì–‘ì‹ ì•ˆë‚´</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>ì•„ë˜ ë‘ ê°€ì§€ ìœ í˜•ì˜ ì‚¬ì§„ì„ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                    <hr>
                    <div class="row text-center">
                        <div class="col-md-6">
                            <h6>1. ë°•ìŠ¤ ë¼ë²¨ </h6>
                            <p class="text-muted">ë°•ìŠ¤ì— ë¶€ì°©ëœ Dell ë¼ë²¨ì„ ì´¬ì˜í•˜ì—¬ ì—…ë¡œë“œí•©ë‹ˆë‹¤.<br> í•˜ë‚˜ì˜ ì£¼ë¬¸ë²ˆí˜¸ë¥¼ ìë™ìœ¼ë¡œ ì¸ì‹í•©ë‹ˆë‹¤.</p>
                            <img src="{{ url_for('static', filename='images/box_label_example.png') }}" class="img-fluid border rounded" alt="ë°•ìŠ¤ ë¼ë²¨ ì˜ˆì‹œ">
                        </div>
                        <div class="col-md-6">
				<br>
                            <h6>2. ë‚©í’ˆ í™•ì¸ì„œ</h6>
                            <p class="text-muted">ì—¬ëŸ¬ ì£¼ë¬¸ì´ í¬í•¨ëœ ë‚©í’ˆ í™•ì¸ì„œë¥¼ ì—…ë¡œë“œí•©ë‹ˆë‹¤.<br> ë¬¸ì„œ ë‚´ì˜ ëª¨ë“  ì£¼ë¬¸ë²ˆí˜¸ë¥¼ í•œ ë²ˆì— ì¸ì‹í•©ë‹ˆë‹¤.</p>
                            <img src="{{ url_for('static', filename='images/delivery_confirmation_example.png') }}" class="img-fluid border rounded" alt="ë‚©í’ˆ í™•ì¸ì„œ ì˜ˆì‹œ">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <script>
        $('form').on('submit', function(event) {
            event.preventDefault(); // Prevent default form submission

            const files = $('#file-input').get(0).files.length;
            const manualEntries = $('input[name="manual_order_numbers[]"]').filter(function() {
                return $(this).val().trim() !== '';
            }).length;

            if (files === 0 && manualEntries === 0) {
                alert("ì—…ë¡œë“œí•  íŒŒì¼ì´ë‚˜ ìˆ˜ë™ìœ¼ë¡œ ì…ë ¥í•œ ì£¼ë¬¸ ë²ˆí˜¸ê°€ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            // Clear previous errors and show spinner
            $('#error-container').empty();
            $('#submit-button').prop('disabled', true);
            $('#loading-spinner').removeClass('d-none');

            const formData = new FormData(this);

            fetch('/process_order', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                // Hide spinner
                $('#submit-button').prop('disabled', false);
                $('#loading-spinner').addClass('d-none');

                if (data.status === 'success') {
                    window.location.href = data.redirect_url;
                } else if (data.status === 'error') {
                    const errorContainer = $('#error-container');
                    // Clear previous errors and display new ones
                    errorContainer.html('');
                    if (data.errors) {
                        data.errors.forEach(error => {
                            errorContainer.append(`<div class="alert alert-danger" role="alert">${error}</div>`);
                        });
                    } else if (data.message) {
                        errorContainer.append(`<div class="alert alert-danger" role="alert">${data.message}</div>`);
                    }
                } else {
                    const errorContainer = $('#error-container');
                    errorContainer.html(`<div class="alert alert-danger" role="alert">${data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'}</div>`);
                }
            })
            .catch(error => {
                console.error('Submission error:', error);
                // Hide spinner and show a generic error
                $('#submit-button').prop('disabled', false);
                $('#loading-spinner').addClass('d-none');
                const errorContainer = $('#error-container');
                errorContainer.html('<div class="alert alert-danger" role="alert">ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>');
            });
        });

        let uploadedFiles = [];

        function updateFileList() {
    const fileInput = document.getElementById('file-input');
    const fileList = document.getElementById('file-list');
    fileList.innerHTML = ''; // ê¸°ì¡´ ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™”

    for (let i = 0; i < fileInput.files.length; i++) {
        const file = fileInput.files[i];
        uploadedFiles.push(file);

        const listItem = document.createElement('li');
        listItem.style.display = 'flex';
        listItem.style.justifyContent = 'space-between';
        listItem.style.alignItems = 'center';
        listItem.style.padding = '10px';
        listItem.style.border = '1px solid #ddd';
        listItem.style.borderRadius = '5px';
        listItem.style.marginBottom = '5px';
        listItem.style.backgroundColor = '#f9f9f9';

        const fileNameSpan = document.createElement('span');
        fileNameSpan.textContent = file.name;

        const buttonContainer = document.createElement('div');
        buttonContainer.style.display = 'flex';
        buttonContainer.style.gap = '10px'; // ë²„íŠ¼ ê°„ ê°„ê²© ì¶”ê°€

        // ë¯¸ë¦¬ë³´ê¸° ë²„íŠ¼
        const previewButton = document.createElement('button');
        previewButton.textContent = 'ë¯¸ë¦¬ë³´ê¸°';
		previewButton.type = 'button';  // type="button"ìœ¼ë¡œ ì„¤ì •í•˜ì—¬ í¼ ì œì¶œ ë°©ì§€
        previewButton.style.backgroundColor = '#007bff';
        previewButton.style.color = 'white';
        previewButton.style.border = 'none';
        previewButton.style.padding = '5px 10px';
        previewButton.style.borderRadius = '5px';
        previewButton.style.cursor = 'pointer';
        previewButton.onclick = (event) => {
            event.preventDefault();  // í¼ ì œì¶œ ë°©ì§€
            previewFile(file);
        };

        // ì‚­ì œ ë²„íŠ¼
        const deleteButton = document.createElement('button');
        deleteButton.textContent = 'ì‚­ì œ';
		deleteButton.type = 'button';  // type="button"ìœ¼ë¡œ ì„¤ì •í•˜ì—¬ í¼ ì œì¶œ ë°©ì§€
        deleteButton.style.backgroundColor = '#dc3545';
        deleteButton.style.color = 'white';
        deleteButton.style.border = 'none';
        deleteButton.style.padding = '5px 10px';
        deleteButton.style.borderRadius = '5px';
        deleteButton.style.cursor = 'pointer';
        deleteButton.onclick = (event) => {
			event.preventDefault();  // í¼ ì œì¶œ ë°©ì§€
            removeFile(file.name);
        };

        buttonContainer.appendChild(previewButton);
        buttonContainer.appendChild(deleteButton);
        listItem.appendChild(fileNameSpan);
        listItem.appendChild(buttonContainer);
        fileList.appendChild(listItem);
    }
}

function removeFile(fileName) {
    const fileInput = document.getElementById('file-input');
    const fileList = document.getElementById('file-list');

    // uploadedFilesì—ì„œ ì²« ë²ˆì§¸ë¡œ ë§¤ì¹­ëœ íŒŒì¼ ì œê±°
    const fileIndex = uploadedFiles.findIndex(file => file.name === fileName);
    if (fileIndex !== -1) {
        uploadedFiles.splice(fileIndex, 1); // ë°°ì—´ì—ì„œ í•´ë‹¹ íŒŒì¼ ì œê±°
    }

    // ìƒˆë¡œìš´ íŒŒì¼ ë¦¬ìŠ¤íŠ¸ë¥¼ ë‹¤ì‹œ ë Œë”ë§
    fileList.innerHTML = '';
    uploadedFiles.forEach(file => {
        const listItem = document.createElement('li');
        const fileNameSpan = document.createElement('span');
        fileNameSpan.textContent = file.name;

        const buttonContainer = document.createElement('div');
        buttonContainer.style.display = 'flex';
        buttonContainer.style.gap = '10px';

        const previewButton = document.createElement('button');
        previewButton.textContent = 'ë¯¸ë¦¬ë³´ê¸°';
        previewButton.type = 'button';
        previewButton.style.backgroundColor = '#007bff';
        previewButton.style.color = 'white';
        previewButton.style.border = 'none';
        previewButton.style.padding = '5px 10px';
        previewButton.style.borderRadius = '5px';
        previewButton.style.cursor = 'pointer';
        previewButton.onclick = () => previewFile(file);

        const deleteButton = document.createElement('button');
        deleteButton.textContent = 'ì‚­ì œ';
        deleteButton.type = 'button';
        deleteButton.style.backgroundColor = '#dc3545';
        deleteButton.style.color = 'white';
        deleteButton.style.border = 'none';
        deleteButton.style.padding = '5px 10px';
        deleteButton.style.borderRadius = '5px';
        deleteButton.style.cursor = 'pointer';
        deleteButton.onclick = () => removeFile(file.name);

        buttonContainer.appendChild(previewButton);
        buttonContainer.appendChild(deleteButton);
        listItem.appendChild(fileNameSpan);
        listItem.appendChild(buttonContainer);
        fileList.appendChild(listItem);
    });

    // fileInput ê°’ ì¬ì„¤ì •
    const dataTransfer = new DataTransfer();
    uploadedFiles.forEach(file => dataTransfer.items.add(file));
    fileInput.files = dataTransfer.files;
}


function previewFile(file) {
            const fileReader = new FileReader();
            fileReader.onload = function(event) {
                const modalImage = document.getElementById('modalImage');
                modalImage.src = event.target.result;  // ëª¨ë‹¬ì˜ ì´ë¯¸ì§€ src ì„¤ì •
                $('#imagePreviewModal').modal('show');  // ëª¨ë‹¬ í‘œì‹œ
            };
            fileReader.readAsDataURL(file);
        }
	
    function addOrderNumberField() {
    const container = document.getElementById('order-number-container');

    const fieldWrapper = document.createElement('div');
    fieldWrapper.className = 'd-flex align-items-center mt-2';

    const input = document.createElement('input');
    input.type = 'text';
    input.name = 'manual_order_numbers[]';
    input.placeholder = 'ì¶”ê°€ ì£¼ë¬¸ ë²ˆí˜¸ ì…ë ¥';
    input.style.flex = '1';
	input.style.width = '100px';  // âœ… í¬ê¸° ì¤„ì´ê¸°

    const select = document.createElement('select');
    select.name = 'box[]';
    select.className = 'form-control ml-2';
    select.style.width = '80px';

    for (let i = 1; i <= 100; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.text = i;
        select.appendChild(option);
    }

    fieldWrapper.appendChild(input);
    fieldWrapper.appendChild(select);
    container.appendChild(fieldWrapper);
}

function notifyAdmin() {
    fetch('/notify_admin', { method: 'POST' })
        .then(res => res.json())
        .then(data => alert(data.message || 'ê´€ë¦¬ìì—ê²Œ ìš”ì²­ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.'))
        .catch(err => alert('ì „ì†¡ ì‹¤íŒ¨: ' + err.message));
}
</script>
